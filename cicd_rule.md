# CI/CD運用ルール

## 1. 目的

この文書は、GitHubを用いたソースコードのバージョン管理とCI/CD運用に関するルールを定め、
チーム開発の効率化と品質向上を目的とする。


## 2. 運用フロー

課題（Issue）作成 → ブランチ作成 → 実装・コミット → PR作成＆レビュー  
　　→ 開発環境デプロイ → 総合環境デプロイ → 検証環境デプロイ  
　　→ mainマージ → 本番デプロイ → タグ付与

## 3. 課題管理

### 3.1 課題管理に GitHub Issues の利用

- Issue番号を課題管理の統一番号とする
- プログラムを修正する（ブランチを作成する）前に必ずIssueを作成する
- Issue作成時にはテンプレートを使用し、必要事項を記入する
- Assigneersには作業者（通常は本人）を設定する
- Issueとブランチやコミットの紐づけには、GitHubの機能を使用する（#Issue番号）
- PullRequestのマージが完了したら、Issue をcloseする

### 3.2 Issueテンプレート

- Issue作成時にメニューより以下を選択する
    - 申請書作成用、アドオン作成用
    - 申請書変更用、アドオン変更用
    - 不具合修正用
- feature（機能追加）、update（機能変更）、bug（不具合）タグを自動付与

### 3.3 マイルストーンタグ

- リリースまとめ用ブランチを使用する場合、マイルストーンのタグを付与する
    - 例：`release_1st_phase`


## 4. ブランチ戦略

- 原則、Ci*Xチームより提供された「アドオン開発ブランチ戦略」に則って開発を進める
[アドオン開発ブランチ戦略（Confluence）](https://docs.aiuo.land/pages/viewpage.action?pageId=901775861)
- ただし、ブランチの命名ルールは以降に定める

### 4.1 ブランチの種類と命名

| ブランチ名 | 用途 | 命名例 | 備考 |
| --- | --- | --- | --- |
| `main` | 本番リリース用 | （固定） | 常に本番と一致 |
| `release_1st_phase` | 初回リリース用 | （固定） | リリース用まとめブランチ |
| `feature_WF3_ADDON_ISSUE_<Issue番号>_<申請書番号またはアドオン名>`  | 申請書および機能ごとの開発用 | `feature_WF3_ADDON_ISSUE_128_form_034` | 機能ブランチ |
| `feature_WF3_ADDON_ISSUE_<Issue番号>_<申請書番号またはアドオン名>_<概要>` | 申請書固有アドオンなどの開発用 | `feature_WF3_ADDON_ISSUE_128_form_034_input_check` | 機能サブブランチ |
| `bugfix_WF3_ADDON_ISSUE_<Issue番号>_<概要>` | バグ修正用 | `bugfix_WF3_ADDON_ISSUE_128_fix-bug` | バグ修正ブランチ |

### 4.2 ブランチ命名ルール

- 日本語は使用しない
- `WF3_ADDON_ISSUE` を含める
- GitHubの `Issue番号`を含める
- 申請書番号には `form_` を、アドオンには `func_` をプレフィックスとして付与する
    - 例： `form_034`, `func_tohanmei_root`
- 原則、機能サブブランチにも機能ブランチと同一の`Issue番号` を付与する

### 4.3 リリースまとめ用ブランチ

- 複数の機能を統合し、本番環境へのデプロイ準備を行うための一時的なブランチ
- まとめリリース対象となる各 `feature` ブランチのマージ先とする
- `main` ブランチから作成し、リリース時に `main` にマージする
- 本番リリース後は削除する
- まとめリリース対象外の申請書や機能については `main` からブランチを作成する


## 5. コミットルール

### 5.1 コミットメッセージ形式

- 最低限、`[#Issue番号]`を含め概要を簡潔に記載する
    - 例：`[#123] 入力チェック追加`


## 6. プルリクエストルール

### 6.1 プルリクエストメッセージ作成

- PRタイトルに `[#Issue番号]` を含めるレビュー内容を簡潔に記載する
    - 例： `[#123] 値引申請（役員決済）作成`


## 7.デプロイサイクル

### 7.1 非本番環境

- PRマージ後に、開発環境 → 総合環境 → 検証環境 の順にリリース
- 現状は手動でリリースを行い、各環境へのリリースタイミングを調整する
- リリースまとめ用ブランチが存在する場合は、リリースまとめ用ブランチをデプロイする

### 7.2 本番環境

- `main` ブランチへのマージ後、本番リリースを行う
- 現状は手動でリリースを行う
- `main` ブランチへのマージ後は速やかに本番リリースを行う


## 8. テスト運用ルール

- デプロイ時にテストプログラムを自動で動かし、デグレードを防ぐことを検討中


## 9. バージョン管理

### 9.1 バージョン付与方針

- 本番リリースごとにタグを付与し、ソースコードのスナップショットを管理する

### バージョンの構成

<メジャー>.<マイナー>.<パッチ>

| バージョン種別 | 説明 | 例 |
| --- | --- | --- |
| メジャー | Ci*Xのバージョンアップで変更が入る場合 | 2.0.0 |
| マイナー | 申請書リリースや新機能リリース時 | 1.1.0 |
| パッチ | バグ修正などの軽微な修正 | 1.0.1 |

### 9.2 タグ作成ルール

- タグ作成はリリース担当者が実施する

